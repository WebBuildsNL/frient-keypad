<!DOCTYPE html>
<html>
<head>
  <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 1em;
      color: #333;
    }
    h2 { margin-top: 0; }
    .table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      margin-bottom: 1.5em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }
    th, td {
      text-align: left;
      padding: 6px 8px;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
    }
    th {
      font-weight: 600;
      font-size: 11px;
      text-transform: uppercase;
      color: #888;
      letter-spacing: 0.3px;
    }
    .empty-msg {
      color: #999;
      font-style: italic;
      padding: 1em 0;
    }
    .form-group {
      margin-bottom: 0.75em;
    }
    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 4px;
    }
    .form-group input {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-primary {
      background: #1E90FF;
      color: #fff;
    }
    .btn-danger {
      background: #e74c3c;
      color: #fff;
      padding: 4px 10px;
      font-size: 13px;
    }
    .btn:hover { opacity: 0.85; }
    .status {
      margin-top: 0.5em;
      font-style: italic;
      color: #27ae60;
    }
    .status-expired { color: #999; }
    .status-active { color: #27ae60; font-weight: 600; }
    .status-future { color: #1E90FF; }

    /* Tabs */
    .tab-bar {
      display: flex;
      border-bottom: 2px solid #eee;
      margin-bottom: 1em;
    }
    .tab-bar button {
      background: none;
      border: none;
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 600;
      color: #888;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .tab-bar button.active {
      color: #1E90FF;
      border-bottom-color: #1E90FF;
    }
    .tab-bar button:hover {
      color: #333;
    }
    .tab-panel {
      display: none;
    }
    .tab-panel.active {
      display: block;
    }

    /* Log */
    #log {
      width: 100%;
      font-family: monospace;
      font-size: 12px;
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 8px;
      box-sizing: border-box;
    }
    .log-legend {
      color: #999;
      font-size: 12px;
      margin-bottom: 8px;
    }
  </style>
</head>
<body>
  <div class="tab-bar">
    <button class="active" data-tab="codes" id="tab-codes"></button>
    <button data-tab="log" id="tab-log"></button>
  </div>

  <div class="tab-panel active" id="panel-codes">
    <h2 id="title-codes" style="display:inline;"></h2> <a href="#" id="refresh-btn" style="font-size:13px; color:#1E90FF; text-decoration:none; vertical-align:middle;"></a>
    <div id="codes-list"></div>

    <h2 id="title-add"></h2>
    <div class="form-group">
      <label for="name" id="label-name"></label>
      <input type="text" id="name" placeholder="Guest 1">
    </div>
    <div class="form-group">
      <label for="code" id="label-code"></label>
      <input type="text" id="code" placeholder="1234" inputmode="numeric">
    </div>
    <div class="form-group">
      <label for="from" id="label-from"></label>
      <input type="datetime-local" id="from">
    </div>
    <div class="form-group">
      <label for="till" id="label-till"></label>
      <input type="datetime-local" id="till">
    </div>
    <div class="form-group">
      <label for="reference_id" id="label-reference_id"></label>
      <input type="text" id="reference_id" placeholder="BOOK-12345">
    </div>
    <button class="btn btn-primary" id="add-btn"></button>
    <div class="status" id="status"></div>
  </div>

  <div class="tab-panel" id="panel-log">
    <p class="log-legend" id="log-legend"></p>
    <textarea rows="20" cols="80" wrap="off" id="log" readonly></textarea>
  </div>

  <script>
    function onHomeyReady(Homey) {
      Homey.ready();

      var __ = function(key) { return Homey.__('settings.' + key); };
      var statusEl = document.getElementById('status');

      function escapeHtml(str) {
        var div = document.createElement('div');
        div.appendChild(document.createTextNode(str));
        return div.innerHTML;
      }

      // --- Tabs ---
      document.getElementById('tab-codes').textContent = __('tab_codes');
      document.getElementById('tab-log').textContent = __('tab_log');

      var tabButtons = document.querySelectorAll('.tab-bar button');
      for (var t = 0; t < tabButtons.length; t++) {
        tabButtons[t].addEventListener('click', function() {
          var target = this.getAttribute('data-tab');
          for (var i = 0; i < tabButtons.length; i++) {
            tabButtons[i].classList.remove('active');
          }
          this.classList.add('active');
          document.getElementById('panel-codes').classList.remove('active');
          document.getElementById('panel-log').classList.remove('active');
          document.getElementById('panel-' + target).classList.add('active');
        });
      }

      // --- Access Codes tab ---
      document.getElementById('title-codes').textContent = __('title_codes');
      document.getElementById('title-add').textContent = __('title_add');
      document.getElementById('label-name').textContent = __('label_name');
      document.getElementById('label-code').textContent = __('label_code');
      document.getElementById('label-from').textContent = __('label_from');
      document.getElementById('label-till').textContent = __('label_till');
      document.getElementById('label-reference_id').textContent = __('label_reference_id');
      document.getElementById('add-btn').textContent = __('btn_add');
      document.getElementById('refresh-btn').textContent = __('btn_refresh');

      function parseLocalDate(str) {
        var parts = str.replace('T', ' ').split(/[- :]/);
        if (parts.length >= 5) return new Date(+parts[0], +parts[1] - 1, +parts[2], +parts[3], +parts[4]);
        return new Date(+parts[0], +parts[1] - 1, +parts[2]);
      }

      function getStatusClass(from, till) {
        var now = new Date();
        var fromDate = parseLocalDate(from);
        var tillDate = parseLocalDate(till);
        if (till && till.length === 10) tillDate.setHours(23, 59, 59, 999);
        if (now > tillDate) return 'status-expired';
        if (now < fromDate) return 'status-future';
        return 'status-active';
      }

      function getStatusLabel(cls) {
        if (cls === 'status-expired') return __('status_expired');
        if (cls === 'status-future') return __('status_upcoming');
        return __('status_active');
      }

      function renderCodes(codes) {
        var container = document.getElementById('codes-list');
        if (!codes || codes.length === 0) {
          container.innerHTML = '<p class="empty-msg">' + escapeHtml(__('empty')) + '</p>';
          return;
        }
        var html = '<div class="table-wrap"><table><tr>'
          + '<th>' + escapeHtml(__('col_name')) + '</th>'
          + '<th>' + escapeHtml(__('col_code')) + '</th>'
          + '<th>' + escapeHtml(__('col_status')) + '</th>'
          + '<th>' + escapeHtml(__('col_from')) + '</th>'
          + '<th>' + escapeHtml(__('col_till')) + '</th>'
          + '<th>' + escapeHtml(__('col_reference_id')) + '</th>'
          + '<th></th></tr>';
        for (var i = 0; i < codes.length; i++) {
          var c = codes[i];
          var cls = getStatusClass(c.from, c.till);
          html += '<tr>'
            + '<td>' + escapeHtml(c.name || '-') + '</td>'
            + '<td>' + escapeHtml(c.code) + '</td>'
            + '<td><span class="' + cls + '">' + getStatusLabel(cls) + '</span></td>'
            + '<td>' + escapeHtml(c.from) + '</td>'
            + '<td>' + escapeHtml(c.till) + '</td>'
            + '<td>' + escapeHtml(c.reference_id != null ? String(c.reference_id) : '-') + '</td>'
            + '<td><button class="btn btn-danger" data-index="' + i + '">' + escapeHtml(__('btn_delete')) + '</button></td>'
            + '</tr>';
        }
        html += '</table></div>';
        container.innerHTML = html;

        var deleteButtons = container.querySelectorAll('.btn-danger');
        for (var j = 0; j < deleteButtons.length; j++) {
          deleteButtons[j].addEventListener('click', function() {
            var idx = parseInt(this.getAttribute('data-index'), 10);
            deleteCode(idx);
          });
        }
      }

      function loadCodes() {
        Homey.get('codes', function(err, codes) {
          if (err) return;
          renderCodes(codes || []);
        });
      }

      function deleteCode(index) {
        Homey.get('codes', function(err, codes) {
          if (err) return;
          codes = codes || [];
          codes.splice(index, 1);
          Homey.set('codes', codes, function(err) {
            if (err) return;
            renderCodes(codes);
            statusEl.textContent = __('removed');
            setTimeout(function() { statusEl.textContent = ''; }, 2000);
          });
        });
      }

      document.getElementById('add-btn').addEventListener('click', function() {
        var name = document.getElementById('name').value.trim();
        var code = document.getElementById('code').value.trim();
        var from = document.getElementById('from').value.replace('T', ' ');
        var till = document.getElementById('till').value.replace('T', ' ');
        var referenceId = document.getElementById('reference_id').value.trim() || null;

        if (!code || !from || !till) {
          Homey.alert(__('error_required'));
          return;
        }

        if (parseLocalDate(till) < parseLocalDate(from)) {
          Homey.alert(__('error_date'));
          return;
        }

        Homey.get('codes', function(err, codes) {
          if (err) return;
          codes = codes || [];
          var duplicate = codes.some(function(c) {
            return c.code === code && c.from === from && c.till === till;
          });
          if (duplicate) {
            Homey.alert(__('error_duplicate'));
            return;
          }
          codes.push({ name: name, code: code, from: from, till: till, reference_id: referenceId });
          Homey.set('codes', codes, function(err) {
            if (err) return;
            renderCodes(codes);
            document.getElementById('name').value = '';
            document.getElementById('code').value = '';
            document.getElementById('from').value = '';
            document.getElementById('till').value = '';
            document.getElementById('reference_id').value = '';
            statusEl.textContent = __('added');
            setTimeout(function() { statusEl.textContent = ''; }, 2000);
          });
        });
      });

      document.getElementById('refresh-btn').addEventListener('click', function(e) {
        e.preventDefault();
        loadCodes();
      });

      // --- Log tab ---
      document.getElementById('log-legend').textContent = __('log_legend');

      function refreshLog() {
        Homey.get('log', function(err, log) {
          if (err) return;
          var logElement = document.getElementById('log');
          logElement.value = log || '';
          logElement.scrollTop = logElement.scrollHeight;
        });
      }

      refreshLog();
      setInterval(refreshLog, 5000);

      // Initial load
      loadCodes();
    }
  </script>
</body>
</html>
